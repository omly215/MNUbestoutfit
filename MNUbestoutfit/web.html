<!DOCTYPE html>

<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø£Ø²ÙŠØ§Ø¡ Ø¬Ø§Ù…Ø¹Ø© MNU</title>
  <style>
    body { font-family: "Arial", sans-serif; direction: rtl; text-align: center; background: #f8f9fa; margin: 0; padding: 0; }
    header, footer { background: #0077b6; color: white; padding: 15px; position: relative; }
    .voting-wrapper { position: relative; max-width: 900px; margin: 20px auto; }
    .voting-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; padding: 20px; }
    .style-card { background: white; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); overflow: hidden; }
    .style-image { width: 100%; height: 280px; object-fit: cover; background: #000; }
    .card-content { padding: 15px; }
    .vote-section { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
    .vote-btn { padding: 8px 16px; background: #0077b6; color: #fff; border: none; border-radius: 8px; cursor: pointer; transition: 0.3s; }
    .vote-btn:hover { background: #005f86; }
    .vote-btn:disabled { background: #6c757d !important; cursor: not-allowed; }
    .results { margin: 20px auto; max-width: 600px; text-align: right; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .arrow { position: absolute; top: 50%; transform: translateY(-50%); width: 45px; height: 45px; border-radius: 50%; background: rgba(0, 0, 0, 0.4); color: white; font-size: 22px; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: background 0.3s; user-select: none; }
    .arrow:hover { background: rgba(0, 0, 0, 0.7); }
    .arrow-left { left: -15px; }
    .arrow-right { right: -15px; }
    .share-section { margin: 30px 0; }
    .input-name { padding: 8px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; margin: 5px; }
    .upload-btn { padding: 10px 20px; background: #28a745; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; margin: 5px; }
    .upload-btn:hover { background: #1e7e34; }
    .results-btn { background: #ffc107; color: #000; }
    .results-btn:hover { background: #e0a800; }
  </style>
</head>
<link rel="stylesheet" href="style.css">
<body>

  <div id="username-display" style="position: absolute; top: 10px; right: 20px; font-weight: bold;">
  <!-- Ù‡Ù†Ø§ Ù‡ÙŠØ¸Ù‡Ø± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
</div>

  
<header>


  


  
  <div style="position: absolute; top: 10px; right: 20px; font-weight: bold; color: black;">
  ðŸ‘¤ <span id="user-display"></span>
</div>
  <h1>ðŸŽ“ Ù…Ø³Ø§Ø¨Ù‚Ø© Ø£Ø²ÙŠØ§Ø¡ Ø¬Ø§Ù…Ø¹Ø© MNU</h1>
  <p>ØµÙˆÙ‘Øª Ø¨ÙŠÙ† Ø§Ù„Ø·Ù„Ø§Ø¨!</p>
</header>

<main>
  <div class="voting-wrapper">
    <div id="voting-container" class="voting-grid"></div>
  
  </div>

  <div class="share-section">
    <input type="text" id="studentName" placeholder="âœï¸  Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ" class="input-name">
    <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="addParticipant(event)">
    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">ðŸ“¸ Ø´Ø§Ø±Ùƒ Ø§Ù„Ø¢Ù†</button>
    <button class="upload-btn results-btn" onclick="showResults()">ðŸ“Š Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
  </div>

  <div id="results" class="results" style="display:none;">
    <h2>ðŸ“Š Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h2>
    <ul id="results-list"></ul>
    <button class="upload-btn" onclick="backToVoting()">ðŸ”™ Ø±Ø¬ÙˆØ¹ Ù„Ù„ØªØµÙˆÙŠØª</button>
  </div>
</main>

<footer>
  <p>&copy; 2025 Ø¬Ø§Ù…Ø¹Ø© MNU - Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ø£Ø²ÙŠØ§Ø¡</p> 
</footer>

<!-- Ø³ÙƒØ±ÙŠØ¨Øª Ø±Ø¦ÙŠØ³ÙŠ -->
<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const supabaseUrl = "https://jmeqvaotdigdvgkaostn.supabase.co"; 
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImptZXF2YW90ZGlnZHZna2Fvc3RuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0Nzg2MDMsImV4cCI6MjA3MTA1NDYwM30.2a78-xTurx8g11ZBWsXkJ5ZW59dw0tYD68D7KPVsvTs"; // Ø­Ø· Ø§Ù„Ù€ anon key
  const client = createClient(supabaseUrl, supabaseKey);

   let students = [];
  const params = new URLSearchParams(window.location.search);
  const voterId = params.get("voter_id");

  // âœ… Ø¹Ø±Ø¶ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù…Ù† Ø¬Ø¯ÙˆÙ„ logins
  async function getUserFromLogins() {
    let res = await fetch("https://api.ipify.org?format=json");
    let dataIp = await res.json();
    const ip = dataIp.ip;

    let { data, error } = await client
      .from("logins")
      .select("email")
      .eq("ip", ip)
      .order("id", { ascending: false })
      .limit(1)
      .single();

    if (error || !data) {
      document.getElementById("user-display").textContent = "Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¬Ù‡ÙˆÙ„";
      return;
    }
    document.getElementById("user-display").textContent = data.email;
  }

  // âœ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ + Ø§Ù„ØªØµÙˆÙŠØªØ§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  async function loadStudents() {
    let { data, error } = await client
      .from("students")
      .select("*")
      .order("votes", { ascending: false });

    if (error) { console.error(error); return; }
    students = data;

    let { data: voted } = await client
      .from("votes")
      .select("student_id")
      .eq("voter_id", voterId);

    const votedIds = voted ? voted.map(v => v.student_id) : [];
    renderAll(votedIds);
  }

  // âœ… Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ† Ù…Ø¹ ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
  function renderAll(votedIds = []) {
    const container = document.getElementById("voting-container");
    container.innerHTML = "";
    if (students.length === 0) {
      container.innerHTML = "<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙƒÙŠÙ† Ø¨Ø¹Ø¯.</p>";
      return;
    }

    students.forEach(student => {
      const card = document.createElement("div");
      card.className = "style-card";
      card.innerHTML = `
        <img src="${student.image}" alt="${student.name}" class="style-image">
        <div class="card-content">
          <h3>${student.name}</h3>
          <div class="vote-section">
            <span>Ø§Ù„ØªØµÙˆÙŠØªØ§Øª: <span id="count-${student.id}">${student.votes}</span></span>
            <button class="vote-btn" id="btn-${student.id}">ØµÙˆÙ‘Øª</button>
          </div>
        </div>
      `;
      container.appendChild(card);

      const btn = card.querySelector(`#btn-${student.id}`);
      btn.addEventListener("click", () => vote(student.id));

      if (votedIds.includes(student.id)) {
        btn.disabled = true;
      }
    });
  }

  // âœ… Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø§Ø±Ùƒ
  window.addParticipant = async function(event) {
    const file = event.target.files[0];
    const name = document.getElementById("studentName").value.trim();
    if (!name) { alert("âŒ Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ!"); return; }
    if (!file) return;

    const fileName = `${Date.now()}-${file.name}`;
    const { error: uploadError } = await client.storage.from("students").upload(fileName, file);
    if (uploadError) { alert("Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©"); return; }

    const { data: publicUrlData } = client.storage.from("students").getPublicUrl(fileName);
    const imageUrl = publicUrlData.publicUrl;

    const { error: insertError } = await client.from("students").insert([{ name, image: imageUrl, votes: 0 }]);
    if (insertError) { alert("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"); return; }

    alert("âœ… ØªÙ… Ø±ÙØ¹ ØµÙˆØ±ØªÙƒ!");
    document.getElementById("studentName").value = "";
    loadStudents();
  }
// âœ… Ø§Ù„ØªØµÙˆÙŠØª
window.vote = async function(studentId) {
  if (!voterId) {
    alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ù‡ÙˆÙŠØªÙƒ");
    return;
  }

  const { data: existingVote } = await client
    .from("votes")
    .select("*")
    .eq("voter_id", voterId)
    .eq("student_id", studentId);

  if (existingVote && existingVote.length > 0) { 
    alert("âŒ Ù„Ù‚Ø¯ ØµÙˆÙ‘ØªØª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ Ù…Ù† Ù‚Ø¨Ù„!"); 
    return; 
  }

  await client.from("votes").insert([{ student_id: studentId, voter_id: voterId }]);

  const student = students.find(s => s.id === studentId);
  student.votes += 1;
  document.getElementById(`count-${student.id}`).textContent = student.votes;
  await client.from("students").update({ votes: student.votes }).eq("id", studentId);

  document.getElementById(`btn-${studentId}`).disabled = true;
};
  // âœ… Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
  window.showResults = function() {
    document.getElementById("voting-container").style.display = "none";
    const resultsDiv = document.getElementById("results");
    resultsDiv.style.display = "block";
    const list = document.getElementById("results-list");
    list.innerHTML = "";
    const sorted = [...students].sort((a, b) => b.votes - a.votes);
    sorted.forEach(s => {
      const li = document.createElement("li");
      li.textContent = `${s.name}: ${s.votes} ØµÙˆØª`;
      list.appendChild(li);
    });
  };

  window.backToVoting = function() {
    document.getElementById("results").style.display = "none";
    document.getElementById("voting-container").style.display = "grid";
    loadStudents();
  };

  // âœ… Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ´ØºÙŠÙ„
  getUserFromLogins();
  loadStudents();

  
</script>

</body>
</html>